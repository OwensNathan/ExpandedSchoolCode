<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; script-src 'self' 'unsafe-inline';">
    <title>Expression Calculator</title>
    <link type="text/css" rel="stylesheet" href="Common.css" />
    <link type="text/css" rel="stylesheet" href="Mobile.css" />
    <link type="text/css" rel="stylesheet" href="Desktop.css" media="screen and (min-width: 500px)"/>
    <style>
        body { 
            position: relative; 
            overflow-x: hidden; 
            min-height: 100vh; 
        }
        #raindrops { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: 0; 
        }
        .raindrop { 
            position: absolute; 
            top: -20px; 
            width: 2px; 
            background: #00f; 
            opacity: 0.7; 
            animation: fall linear infinite; 
            transform: rotate(-10deg); 
            box-shadow: 0 0 5px #00f, 0 0 10px #00f, 0 0 20px #0ff; 
        }
        @keyframes fall { 
            0% { transform: translateY(0) rotate(-10deg); opacity: 0.7; } 
            100% { transform: translateY(110vh) rotate(-10deg); opacity: 0.1; } 
        }
        header, footer, main, nav { 
            position: relative; 
            z-index: 1; 
        }
        .content { 
            max-width: 600px; 
            margin: 20px auto; 
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        input[type="text"], input[type="number"], select { 
            width: 100%; 
            padding: 8px; 
            margin-bottom: 15px; 
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="number"] {
            width: 48%;
            display: inline-block;
            margin-right: 2%;
        }
        input[type="number"]:last-child {
            margin-right: 0;
        }
        .calc-button { 
            padding: 10px 20px; 
            cursor: pointer; 
            margin-right: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
        }
        .calc-button:hover {
            background: #45a049;
        }
        .result { 
            background: rgba(76, 175, 80, 0.2); 
            padding: 15px; 
            margin: 15px 0; 
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
        }
        .error {
            background: rgba(244, 67, 54, 0.2);
            border-left-color: #f44336;
        }
        .about-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }
        .about-section ul {
            text-align: left;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="raindrops"></div>

    <header>
        <h1>Expression Calculator</h1>
    </header>

    <nav class="navbar">
        <div class="home-icon">
            <a href="HomePage.html"><img src="Picture1.png" alt="Home icon which is a hyperlink to the home page"></a>
        </div>
        <div class="buttons">
            <a href="index.html">
                <button>Game Arcade</button>
            </a>
            <a href="HomePage.html">
                <button>RTS Games Home</button>
            </a>
            <a href="StarCraft.html">
                <button>StarCraft Series</button>
            </a>
            <a href="AgeofEmpires.html">
                <button>Age of Empires</button>
            </a>
        </div>
    </nav>

    <main>
        <div class="content">
            <h2>Expression Calculator</h2>
            
            <div id="resultDiv"></div>
            
            <label for="calcFunction"><strong>Select function:</strong></label>
            <select id="calcFunction">
                <option value="">-- Select Function --</option>
                <option value="evaluateExpression" selected>Evaluate Expression</option>
                <option value="graph">Graph</option>
            </select>

            <label for="calcInput"><strong>Enter expression:</strong></label>
            <input type="text" id="calcInput" placeholder="e.g., (2+3)(4+5) or 2^3 or x^2-7">
            
            <div id="graphRangeDiv" style="display: none;">
                <label for="xMin"><strong>X Min:</strong></label>
                <input type="number" id="xMin" value="-10" step="1">
                
                <label for="xMax"><strong>X Max:</strong></label>
                <input type="number" id="xMax" value="10" step="1">
            </div>
            
            <button class="calc-button" id="calcBtn">Calculate</button>
            
            <canvas id="graphCanvas" width="500" height="400" style="display: none; background: white; border: 1px solid #ccc; margin: 20px auto; border-radius: 4px;"></canvas>

            <div class="about-section">
                <h3>About</h3>
                <p><strong>Evaluate Expression:</strong> Safely handles +, -, *, /, ^, negative numbers, parentheses, and implicit multiplicationâ€”including numbers next to numbers like "2 3" and chained parentheses "(2+3)(4+5)(6+7)".</p>
                <p><strong>Expression Examples:</strong></p>
                <ul>
                    <li>2 + 3 * 4 = 14</li>
                    <li>(2+3)(4+5) = 45</li>
                    <li>2^3 = 8</li>
                    <li>2 3 = 6 (implicit multiplication)</li>
                    <li>-5 + 10 = 5</li>
                    <li>(2+3)(4+5)(6+7) = 585</li>
                </ul>
                <p><strong>Graph:</strong> Visualize functions with variable 'x'. Use the Graph option to plot equations like y=x^2-7.</p>
                <p><strong>Graph Examples:</strong></p>
                <ul>
                    <li>x^2-7 (parabola)</li>
                    <li>2*x+3 (linear)</li>
                    <li>x^3-2*x (cubic)</li>
                    <li>(x-2)^2+1 (shifted parabola)</li>
                </ul>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Multi-Game Arcade & RTS Games Info</p>
    </footer>

    <script>
        // Calculator functionality
        function evaluateExpression(expr) {
            expr = expr.replace(/\s/g, '');

            // Global implicit multiplication:
            // 1. Number or ')' followed by '('
            expr = expr.replace(/(\d|\))(\()/g, '$1*$2');
            // 2. ')' followed by number
            expr = expr.replace(/(\))(\d)/g, '$1*$2');
            // 3. Number followed by number (e.g., "2 3" becomes "2*3")
            expr = expr.replace(/(\d)(?=\d)/g, '$1*');

            if (/[^0-9+\-*\/^().]/.test(expr)) {
                throw new Error("Invalid characters in expression");
            }

            return evaluateTokens(tokenize(expr));
        }

        function tokenize(expr) {
            const tokens = [];
            let number = '';
            const length = expr.length;

            for (let i = 0; i < length; i++) {
                const char = expr[i];

                // Number or decimal
                if (/\d/.test(char) || char === '.') {
                    number += char;
                } else {
                    if (number !== '') {
                        tokens.push(number);
                        number = '';
                    }

                    // Handle negative numbers
                    if (char === '-' && (i === 0 || '+-*/(^'.includes(expr[i - 1]))) {
                        number = '-';
                    } else {
                        tokens.push(char);
                    }
                }
            }
            if (number !== '') tokens.push(number);
            return tokens;
        }

        function evaluateTokens(tokens) {
            const values = [];
            const ops = [];
            const precedence = {
                '+': [1, 'L'],
                '-': [1, 'L'],
                '*': [2, 'L'],
                '/': [2, 'L'],
                '^': [3, 'R']
            };

            const applyOp = () => {
                const b = values.pop();
                const a = values.pop();
                const op = ops.pop();

                switch (op) {
                    case '+': values.push(a + b); break;
                    case '-': values.push(a - b); break;
                    case '*': values.push(a * b); break;
                    case '/':
                        if (b === 0) throw new Error("Division by zero");
                        values.push(a / b);
                        break;
                    case '^': values.push(Math.pow(a, b)); break;
                }
            };

            for (const token of tokens) {
                if (!isNaN(parseFloat(token))) {
                    values.push(parseFloat(token));
                } else if (token === '(') {
                    ops.push(token);
                } else if (token === ')') {
                    while (ops.length > 0 && ops[ops.length - 1] !== '(') {
                        applyOp();
                    }
                    if (ops.length === 0) throw new Error("Mismatched parentheses");
                    ops.pop();
                } else if (precedence[token]) {
                    const [p1, assoc1] = precedence[token];
                    while (ops.length > 0 && precedence[ops[ops.length - 1]]) {
                        const [p2] = precedence[ops[ops.length - 1]];
                        if ((assoc1 === 'L' && p1 <= p2) || (assoc1 === 'R' && p1 < p2)) {
                            applyOp();
                        } else {
                            break;
                        }
                    }
                    ops.push(token);
                } else {
                    throw new Error("Invalid token: " + token);
                }
            }

            while (ops.length > 0) {
                if (ops[ops.length - 1] === '(' || ops[ops.length - 1] === ')') {
                    throw new Error("Mismatched parentheses");
                }
                applyOp();
            }

            if (values.length !== 1) throw new Error("Invalid expression");
            return values[0];
        }

        // Graph a function
        function graphFunction(expr, xMin, xMax) {
            const canvas = document.getElementById('graphCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);
            
            // Replace 'x' with a placeholder for evaluation
            const cleanExpr = expr.replace(/\s/g, '');
            
            // Calculate y values
            const points = [];
            let yMin = Infinity;
            let yMax = -Infinity;
            const steps = 500;
            
            for (let i = 0; i <= steps; i++) {
                const x = xMin + (xMax - xMin) * (i / steps);
                try {
                    // Replace x in expression with actual value (using word boundary to avoid replacing x in function names)
                    const exprWithX = cleanExpr.replace(/\bx\b/g, `(${x})`);
                    const y = evaluateExpression(exprWithX);
                    
                    if (isFinite(y)) {
                        points.push({ x, y });
                        yMin = Math.min(yMin, y);
                        yMax = Math.max(yMax, y);
                    }
                } catch (e) {
                    // Skip invalid points
                }
            }
            
            if (points.length === 0) {
                throw new Error("No valid points to graph");
            }
            
            // Add padding to y range
            const yRange = yMax - yMin;
            const yPadding = yRange * 0.1;
            yMin -= yPadding;
            yMax += yPadding;
            
            // Draw grid and axes
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // Vertical grid lines
            for (let i = 0; i <= 10; i++) {
                const x = (width * i) / 10;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // Horizontal grid lines
            for (let i = 0; i <= 10; i++) {
                const y = (height * i) / 10;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            
            // Y-axis (x=0)
            if (xMin <= 0 && xMax >= 0) {
                const axisX = ((0 - xMin) / (xMax - xMin)) * width;
                ctx.beginPath();
                ctx.moveTo(axisX, 0);
                ctx.lineTo(axisX, height);
                ctx.stroke();
            }
            
            // X-axis (y=0)
            if (yMin <= 0 && yMax >= 0) {
                const axisY = height - ((0 - yMin) / (yMax - yMin)) * height;
                ctx.beginPath();
                ctx.moveTo(0, axisY);
                ctx.lineTo(width, axisY);
                ctx.stroke();
            }
            
            // Draw function
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < points.length; i++) {
                const point = points[i];
                const canvasX = ((point.x - xMin) / (xMax - xMin)) * width;
                const canvasY = height - ((point.y - yMin) / (yMax - yMin)) * height;
                
                if (i === 0) {
                    ctx.moveTo(canvasX, canvasY);
                } else {
                    ctx.lineTo(canvasX, canvasY);
                }
            }
            ctx.stroke();
            
            // Draw labels
            ctx.fillStyle = '#000';
            ctx.font = '12px Arial';
            
            // X-axis labels
            ctx.fillText(xMin.toFixed(1), 5, height - 5);
            ctx.fillText(xMax.toFixed(1), width - 35, height - 5);
            
            // Y-axis labels
            ctx.fillText(yMax.toFixed(1), 5, 15);
            ctx.fillText(yMin.toFixed(1), 5, height - 25);
            
            // Expression label
            ctx.fillText(`y = ${expr}`, width / 2 - 40, 20);
        }

        // Load saved values from localStorage
        window.addEventListener('DOMContentLoaded', function() {
            const savedExpr = localStorage.getItem('calc_last_expression');
            const savedFunc = localStorage.getItem('calc_last_function');
            
            if (savedExpr) {
                document.getElementById('calcInput').value = savedExpr;
            }
            if (savedFunc) {
                document.getElementById('calcFunction').value = savedFunc;
                updateUIForFunction(savedFunc);
            }

            // Create raindrops
            createRaindrops();
        });

        // Show/hide graph range inputs based on selected function
        document.getElementById('calcFunction').addEventListener('change', function() {
            updateUIForFunction(this.value);
        });

        function updateUIForFunction(func) {
            const graphRangeDiv = document.getElementById('graphRangeDiv');
            const calcInput = document.getElementById('calcInput');
            
            if (func === 'graph') {
                graphRangeDiv.style.display = 'block';
                calcInput.placeholder = 'e.g., x^2-7 or 2*x+3 or x^3-2*x';
            } else {
                graphRangeDiv.style.display = 'none';
                calcInput.placeholder = 'e.g., (2+3)(4+5) or 2^3 or 2 3';
            }
        }

        function calculate() {
            const input = document.getElementById('calcInput').value;
            const func = document.getElementById('calcFunction').value;
            const resultDiv = document.getElementById('resultDiv');
            const canvas = document.getElementById('graphCanvas');

            if (func === 'evaluateExpression') {
                canvas.style.display = 'none';
                try {
                    const result = evaluateExpression(input);
                    resultDiv.innerHTML = `<div class="result"><strong>Result:</strong> ${result}</div>`;
                    
                    // Save to localStorage
                    localStorage.setItem('calc_last_expression', input);
                    localStorage.setItem('calc_last_function', func);
                } catch (e) {
                    resultDiv.innerHTML = `<div class="result error"><strong>Error:</strong> ${e.message}</div>`;
                }
            } else if (func === 'graph') {
                resultDiv.innerHTML = '';
                try {
                    const xMin = parseFloat(document.getElementById('xMin').value);
                    const xMax = parseFloat(document.getElementById('xMax').value);
                    
                    if (xMin >= xMax) {
                        throw new Error("X Min must be less than X Max");
                    }
                    
                    graphFunction(input, xMin, xMax);
                    canvas.style.display = 'block';
                    
                    // Save to localStorage
                    localStorage.setItem('calc_last_expression', input);
                    localStorage.setItem('calc_last_function', func);
                } catch (e) {
                    canvas.style.display = 'none';
                    resultDiv.innerHTML = `<div class="result error"><strong>Error:</strong> ${e.message}</div>`;
                }
            } else {
                canvas.style.display = 'none';
                resultDiv.innerHTML = `<div class="result error"><strong>Error:</strong> Please select a valid function.</div>`;
            }
        }

        // Event listeners
        document.getElementById('calcBtn').addEventListener('click', calculate);
        document.getElementById('calcInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculate();
            }
        });

        // Raindrops animation
        function createRaindrops() {
            const container = document.getElementById('raindrops');
            const raindropCount = 150;
            
            for (let i = 0; i < raindropCount; i++) {
                const drop = document.createElement('div');
                drop.classList.add('raindrop');
                drop.style.left = Math.random() * 100 + 'vw';
                drop.style.height = (5 + Math.random() * 25) + 'px';
                drop.style.opacity = (0.3 + Math.random() * 0.7).toString();
                drop.style.animationDuration = (0.5 + Math.random() * 2) + 's';
                drop.style.transform = `rotate(${-10 + Math.random() * 20}deg)`;
                container.appendChild(drop);
            }
        }
    </script>
</body>
</html>
